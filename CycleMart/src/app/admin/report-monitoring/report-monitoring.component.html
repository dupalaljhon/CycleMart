<div class="flex h-screen bg-gray-50">
  <!-- Admin Sidenav -->
  <app-admin-sidenav></app-admin-sidenav>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Header -->
    <mat-toolbar class="bg-white shadow-sm border-b">
      <mat-icon class="mr-3 text-red-600">warning</mat-icon>
      <span class="text-xl font-semibold">Report Monitoring</span>
      <span class="flex-1"></span>
      <button mat-raised-button color="primary" (click)="refreshReports()" [disabled]="loading">
        <mat-icon>refresh</mat-icon>
        Refresh
      </button>
      <button mat-stroked-button class="ml-2" (click)="exportReports()">
        <mat-icon>download</mat-icon>
        Export
      </button>
      <!-- <button mat-stroked-button class="ml-2" (click)="debugAllProofData()" color="warn">
        <mat-icon>bug_report</mat-icon>
        Debug Proof
      </button> -->
    </mat-toolbar>

    <!-- Filters Section -->
    <mat-card class="m-4 mb-0">
      <mat-card-content>
        <div class="flex flex-wrap gap-4 items-end">
          <!-- Search Filter -->
          <mat-form-field class="flex-1 min-w-60">
            <mat-label>Search Reports</mat-label>
            <input matInput [(ngModel)]="searchFilter" (input)="applyFilter()" 
                   placeholder="Search by reporter, reported user, product, or details...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <!-- Status Filter -->
          <mat-form-field class="w-48">
            <mat-label>Status</mat-label>
            <mat-select [(ngModel)]="statusFilter" (selectionChange)="applyFilter()">
              <mat-option *ngFor="let status of statusOptions" [value]="status.value">
                {{ status.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Reason Type Filter -->
          <mat-form-field class="w-56">
            <mat-label>Reason Type</mat-label>
            <mat-select [(ngModel)]="reasonTypeFilter" (selectionChange)="applyFilter()">
              <mat-option *ngFor="let reason of reasonTypeOptions" [value]="reason.value">
                {{ reason.label }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <!-- Clear Filters Button -->
          <!-- <button mat-stroked-button (click)="clearFilters()" class="h-14">
            <mat-icon>clear</mat-icon>
            Clear Filters
          </button> -->
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Table Content -->
    <div class="flex-1 overflow-auto m-4 mt-2 relative">
      <mat-card class="rounded-lg shadow-sm">
        <mat-card-content class="p-0">
          <!-- Loading State -->
          <div *ngIf="loading" class="flex justify-center items-center h-64">
            <div class="text-center">
              <mat-icon class="animate-spin text-4xl mb-4 text-blue-600">refresh</mat-icon>
              <p class="text-gray-600 font-medium">Loading reports...</p>
            </div>
          </div>

          <!-- Error State -->
          <div *ngIf="error && !loading" class="flex justify-center items-center h-64">
            <div class="text-center">
              <mat-icon class="text-red-500 text-4xl mb-4">error_outline</mat-icon>
              <p class="text-red-600 mb-4 font-medium">{{ error }}</p>
              <button mat-raised-button color="primary" (click)="loadReports()" class="minimal-button">
                Try Again
              </button>
            </div>
          </div>

          <!-- Reports Table -->
          <div *ngIf="!loading && !error" class="overflow-x-auto">
            <table mat-table [dataSource]="dataSource" matSort class="w-full modern-table">
              <!-- Reporter Info Column -->
              <ng-container matColumnDef="reporter_info">
                <th mat-header-cell *matHeaderCellDef class="font-bold min-w-48">Reporter</th>
                <td mat-cell *matCellDef="let report">
                  <div class="flex items-center space-x-3">
                    <img [src]="getUserProfileImageUrl(report.reporter_profile_image)" 
                         [alt]="report.reporter_name || 'Reporter'"
                         class="w-10 h-10 object-cover rounded-full border border-gray-200"
                         (error)="onReporterImageError($event)">
                    <div>
                      <div class="font-medium">{{ report.reporter_name || 'Unknown' }}</div>
                      <div class="text-sm text-gray-500">{{ report.reporter_email || 'N/A' }}</div>
                      <div class="text-xs text-blue-600 font-mono">#{{ report.report_id }}</div>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Reported Target Column -->
              <ng-container matColumnDef="reported_target">
                <th mat-header-cell *matHeaderCellDef class="font-bold min-w-56">Reported Target</th>
                <td mat-cell *matCellDef="let report">
                  <!-- Product Report -->
                  <div *ngIf="report.product_id" class="flex items-center space-x-3">
                    <img [src]="getProductImageUrl(report.product_images)" 
                         [alt]="report.product_name" 
                         class="w-12 h-12 object-cover rounded-lg border"
                         (error)="onImageError($event)">
                    <div class="flex-1 min-w-0">
                      <div class="font-medium text-sm">{{ truncateText(report.product_name, 30) }}</div>
                      <div class="text-xs text-green-600" *ngIf="report.product_price">
                        ${{ report.product_price }}
                      </div>
                      <div class="text-xs text-gray-500">
                        {{ truncateText(report.product_description, 40) }}
                      </div>
                    </div>
                  </div>

                  <!-- User Report -->
                  <div *ngIf="report.reported_user_id && !report.product_id" class="flex items-center space-x-2">
                    <mat-icon class="text-purple-600">account_circle</mat-icon>
                    <div>
                      <div class="font-medium">{{ report.reported_user_name || 'Unknown User' }}</div>
                      <div class="text-sm text-gray-500">{{ report.reported_user_email || 'N/A' }}</div>
                    </div>
                  </div>
                </td>
              </ng-container>

              <!-- Reason Type Column -->
              <ng-container matColumnDef="reason_type">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-bold">Reason</th>
                <td mat-cell *matCellDef="let report">
                  <mat-chip-set>
                    <mat-chip [class]="'reason-' + report.reason_type.replace(' ', '-')">
                      <mat-icon matChipAvatar>{{ getReasonTypeIcon(report.reason_type) }}</mat-icon>
                      {{ report.reason_type | titlecase }}
                    </mat-chip>
                  </mat-chip-set>
                </td>
              </ng-container>

              <!-- Reason Details Column -->
              <ng-container matColumnDef="reason_details">
                <th mat-header-cell *matHeaderCellDef class="font-bold min-w-64">Details</th>
                <td mat-cell *matCellDef="let report">
                  <div class="max-w-xs">
                    <p class="text-sm text-gray-700 italic" 
                       [matTooltip]="report.reason_details || 'No details provided'"
                       [matTooltipDisabled]="!report.reason_details || report.reason_details.length <= 50">
                      "{{ truncateText(report.reason_details, 50) }}"
                    </p>
                  </div>
                </td>
              </ng-container>

              <!-- Proof Column -->
              <ng-container matColumnDef="proof">
                <th mat-header-cell *matHeaderCellDef class="font-bold min-w-32">Proof Files</th>
                <td mat-cell *matCellDef="let report">
                  <!-- No proof files case -->
                  <div *ngIf="!report.proof || getProofFileUrls(report.proof).length === 0" class="text-xs text-gray-500">
                    No proof files
                  </div>
                  
                  <!-- Proof data integrity issues warning -->
                  <div *ngIf="report.proof && hasProofDataIssues(report.proof) && getProofFileUrls(report.proof).length === 0" 
                       class="text-xs text-red-500 bg-red-50 p-2 rounded border border-red-200">
                    ⚠️ Corrupted proof data<br>
                    <span class="text-xs text-gray-600">Data: {{report.proof | slice:0:30}}...</span>
                  </div>
                  
                  <!-- Valid proof files with View button -->
                  <div *ngIf="report.proof && getProofFileUrls(report.proof).length > 0" class="flex flex-col items-center gap-1">
                    <button mat-button 
                            (click)="viewProofFiles(report)"
                            class="minimal-view-button text-blue-600 hover:bg-blue-50">
                      <mat-icon class="text-base mr-1">visibility</mat-icon>
                      <span class="text-sm">View ({{ getProofFileUrls(report.proof).length }})</span>
                    </button>
                  </div>
                </td>
              </ng-container>

              <!-- Status Column -->
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-bold">Status</th>
                <td mat-cell *matCellDef="let report">
                  <mat-chip-set>
                    <mat-chip [class]="getStatusClass(report.status)">
                      {{ report.status | titlecase }}
                    </mat-chip>
                  </mat-chip-set>
                </td>
              </ng-container>

              <!-- Created At Column -->
              <ng-container matColumnDef="created_at">
                <th mat-header-cell *matHeaderCellDef mat-sort-header class="font-bold">Created</th>
                <td mat-cell *matCellDef="let report">
                  <div class="text-sm">
                    <div>{{ formatDate(report.created_at) }}</div>
                  </div>
                </td>
              </ng-container>

              <!-- Reviewed Info Column -->
              <ng-container matColumnDef="reviewed_info">
                <th mat-header-cell *matHeaderCellDef class="font-bold">Reviewed By</th>
                <td mat-cell *matCellDef="let report">
                  <div *ngIf="report.reviewed_by_name" class="text-sm">
                    <div class="font-medium">{{ report.reviewed_by_name }}</div>
                    <div class="text-gray-500" *ngIf="report.reviewed_at">
                      {{ formatDate(report.reviewed_at) }}
                    </div>
                  </div>
                  <div *ngIf="!report.reviewed_by_name" class="text-gray-400 text-sm">
                    Not reviewed
                  </div>
                </td>
              </ng-container>

              <!-- Actions Column -->
              <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef class="font-bold">Actions</th>
                <td mat-cell *matCellDef="let report">
                  <div class="flex space-x-1">
                    <button mat-icon-button 
                            color="primary"
                            [disabled]="report.status === 'reviewed'"
                            (click)="markAsReviewed(report)"
                            matTooltip="Mark as Reviewed">
                      <mat-icon>visibility</mat-icon>
                    </button>
                    <button mat-icon-button 
                            color="accent"
                            [disabled]="report.status === 'action_taken'"
                            (click)="markAsActionTaken(report)"
                            matTooltip="Mark as Action Taken">
                      <mat-icon>done</mat-icon>
                    </button>
                    <button mat-icon-button 
                            [disabled]="report.status === 'pending'"
                            (click)="resetToPending(report)"
                            matTooltip="Reset to Pending">
                      <mat-icon>refresh</mat-icon>
                    </button>
                  </div>
                </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true" class="modern-header-row"></tr>
              <tr mat-row *matRowDef="let row; columns: displayedColumns;" 
                  class="hover:bg-gray-50 transition-colors duration-200"></tr>
            </table>

            <!-- No Data State -->
            <div *ngIf="dataSource.data.length === 0" class="text-center py-12">
              <mat-icon class="text-gray-400 text-6xl mb-4">inbox</mat-icon>
              <h3 class="text-xl font-medium text-gray-600 mb-2">No Reports Found</h3>
              <p class="text-gray-500">There are no reports matching your current filters.</p>
            </div>

            <!-- Paginator -->
            <mat-paginator [pageSizeOptions]="[10, 25, 50, 100]" 
                           [pageSize]="25"
                           showFirstLastButtons
                           class="border-t">
            </mat-paginator>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>

<!-- Proof Files Viewing Modal -->
<div *ngIf="showProofModal" 
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
     style="z-index: 9999;"
     (click)="closeProofModal()">
  <div class="relative w-full max-w-5xl max-h-[95vh] bg-white rounded-xl shadow-xl overflow-hidden mx-4" 
       (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="flex justify-between items-center px-6 py-4 bg-white border-b border-gray-100">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
          <mat-icon class="text-blue-600 text-lg">attach_file</mat-icon>
        </div>
        <div>
          <h3 class="text-lg font-medium text-gray-900">
            Proof Files
          </h3>
          <p class="text-sm text-gray-500">
            Report #{{ currentReportId }} • {{ currentProofIndex + 1 }} of {{ currentProofFiles.length }}
          </p>
        </div>
      </div>
      <button mat-icon-button 
              (click)="closeProofModal()" 
              class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="flex flex-col items-center justify-center p-8 min-h-[500px] max-h-[75vh] overflow-auto bg-gray-50">
      <!-- Image Display -->
      <div *ngIf="isCurrentFileImage()" class="flex flex-col items-center w-full">
        <div class="relative bg-white rounded-lg shadow-sm p-4 max-w-full">
          <img [src]="getCurrentProofFile()" 
               [alt]="'Proof file ' + (currentProofIndex + 1)"
               class="max-w-full max-h-[60vh] object-contain rounded-md"
               (error)="onModalImageError($event)">
        </div>
        <p class="mt-4 text-sm text-gray-600 text-center font-medium">
          {{ getProofFileType(getCurrentProofFile()) }} • File {{ currentProofIndex + 1 }} of {{ currentProofFiles.length }}
        </p>
      </div>

      <!-- Video Display -->
      <div *ngIf="isCurrentFileVideo()" class="flex flex-col items-center w-full">
        <div class="relative bg-white rounded-lg shadow-sm p-4 max-w-full">
          <video [src]="getCurrentProofFile()" 
                 controls 
                 class="max-w-full max-h-[60vh] rounded-md"
                 preload="metadata">
            Your browser does not support the video tag.
          </video>
        </div>
        <p class="mt-4 text-sm text-gray-600 text-center font-medium">
          {{ getProofFileType(getCurrentProofFile()) }} • File {{ currentProofIndex + 1 }} of {{ currentProofFiles.length }}
        </p>
      </div>

      <!-- Unsupported File Type -->
      <div *ngIf="!isCurrentFileImage() && !isCurrentFileVideo()" class="flex flex-col items-center text-center">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
          <mat-icon class="text-4xl text-gray-400">insert_drive_file</mat-icon>
        </div>
        <h4 class="text-lg font-medium text-gray-800 mb-2">Preview Not Available</h4>
        <p class="text-sm text-gray-500 mb-6 max-w-md">This file type cannot be previewed in the browser.</p>
        <button mat-raised-button 
                color="primary" 
                (click)="openProofFile(getCurrentProofFile())"
                class="minimal-button">
          <mat-icon class="mr-2">open_in_new</mat-icon>
          Open File
        </button>
      </div>

      <!-- Error State -->
      <div *ngIf="currentProofFiles.length === 0" class="flex flex-col items-center text-center">
        <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mb-4">
          <mat-icon class="text-4xl text-red-400">error_outline</mat-icon>
        </div>
        <h4 class="text-lg font-medium text-gray-800 mb-2">No Files Available</h4>
        <p class="text-sm text-gray-500">No proof files found for this report.</p>
      </div>
    </div>

    <!-- Modal Footer with Navigation -->
    <div *ngIf="currentProofFiles.length > 0" class="flex justify-between items-center px-6 py-4 bg-white border-t border-gray-100">
      <!-- Previous Button -->
      <button mat-button 
              [disabled]="currentProofIndex === 0"
              (click)="previousProofFile()"
              class="minimal-nav-button">
        <mat-icon class="mr-1 text-lg">chevron_left</mat-icon>
        Previous
      </button>

      <!-- File Navigation Indicators -->
      <div class="flex items-center space-x-4">
        <span class="text-sm text-gray-500 font-medium">
          {{ currentProofIndex + 1 }} / {{ currentProofFiles.length }}
        </span>
        <!-- Dots Navigation -->
        <div class="flex space-x-1" *ngIf="currentProofFiles.length > 1">
          <button *ngFor="let file of currentProofFiles; let i = index" 
                  class="w-2 h-2 rounded-full transition-all duration-200 focus:outline-none"
                  [class.bg-blue-600]="i === currentProofIndex"
                  [class.bg-gray-300]="i !== currentProofIndex"
                  [class.hover:bg-gray-400]="i !== currentProofIndex"
                  (click)="currentProofIndex = i">
          </button>
        </div>
      </div>

      <!-- Next Button -->
      <button mat-button 
              [disabled]="currentProofIndex === currentProofFiles.length - 1"
              (click)="nextProofFile()"
              class="minimal-nav-button">
        Next
        <mat-icon class="ml-1 text-lg">chevron_right</mat-icon>
      </button>
    </div>

    
  </div>
</div>