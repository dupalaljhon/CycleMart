<div class="flex h-screen bg-[#f5f1eb]">
  <!-- Sidenav - Hidden on mobile when chat is open -->
  <div [ngClass]="isMobile && showChatWindow ? 'hidden' : 'block'">
    <app-sidenav></app-sidenav>
  </div>

  <!-- Main Page Content -->
  <div class="flex-1 flex shadow-lg rounded-lg overflow-hidden bg-white m-2 md:m-4">
    
    <!-- Enhanced Sidebar Messages List -->
    <div [ngClass]="[
      'bg-white border-r border-gray-200 flex flex-col transition-all duration-300',
      isMobile ? (showChatList ? 'w-full' : 'hidden') : 'w-full md:w-1/3'
    ]">
      <!-- Sidebar Header -->
      <div class="bg-gradient-to-r from-[#6BA3BE] to-[#5a8fa4] text-white p-3 md:p-4 flex items-center justify-between">
        <div class="flex items-center space-x-2 md:space-x-3">
          <div class="w-8 h-8 md:w-10 md:h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
            <svg class="w-4 h-4 md:w-6 md:h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-base md:text-lg">Messages</h2>
            <p class="text-xs md:text-sm opacity-75">{{ getTotalUnreadCount() }} unread</p>
          </div>
        </div>
        
        <!-- Search Icon -->
        <button class="w-6 h-6 md:w-8 md:h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-opacity-30 transition-all">
          <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
        </button>
      </div>

      <!-- Messages List -->
      <div class="flex-1 overflow-y-auto">
        <div *ngFor="let chat of messages; let i = index" 
             [ngClass]="selectedChat?.id === chat.id ? 'bg-[#6BA3BE] bg-opacity-10 border-r-4 border-[#6BA3BE]' : 'hover:bg-gray-50'"
             class="flex items-center p-3 md:p-4 cursor-pointer border-b border-gray-100 transition-all duration-200 group"
             (click)="selectChat(i)">
          
          <div class="relative mr-2 md:mr-3 flex-shrink-0">
            <img [src]="chat.avatar" 
                 class="w-10 h-10 md:w-12 md:h-12 rounded-full border-2 border-gray-200" 
                 alt="avatar">
            <!-- Online Status -->
            <div *ngIf="chat.isOnline" 
                 class="absolute bottom-0 right-0 w-2 h-2 md:w-3 md:h-3 bg-green-500 rounded-full border-2 border-white"></div>
          </div>
          
          <div class="flex-1 min-w-0">
            <div class="flex items-center justify-between mb-1">
              <h3 class="font-semibold text-sm md:text-base text-gray-800 truncate">{{ chat.name }}</h3>
              <span class="text-xs text-gray-500 flex-shrink-0 ml-2">{{ chat.lastMessageTime }}</span>
            </div>
            <div class="flex items-center justify-between">
              <p class="text-xs md:text-sm text-gray-600 truncate flex-1">{{ chat.lastMessage }}</p>
              <!-- Unread Badge -->
              <div *ngIf="chat.unreadCount > 0" 
                   class="ml-2 bg-[#6BA3BE] text-white text-xs rounded-full w-4 h-4 md:w-5 md:h-5 flex items-center justify-center flex-shrink-0">
                {{ chat.unreadCount }}
              </div>
            </div>
          </div>
          
          <!-- Delete Button - Hidden on mobile, shown on hover on desktop -->
          <button (click)="deleteChat(i); $event.stopPropagation()"
                  class="ml-2 opacity-0 md:group-hover:opacity-100 w-5 h-5 md:w-6 md:h-6 text-red-500 hover:text-red-700 transition-all flex-shrink-0">
            <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
            </svg>
          </button>
        </div>
      </div>
    </div>

    <!-- Enhanced Chat Window -->
    <div [ngClass]="[
      'flex flex-col bg-gray-50 transition-all duration-300',
      isMobile ? (showChatWindow ? 'w-full' : 'hidden') : 'w-full md:w-2/3'
    ]" *ngIf="selectedChat || !isMobile">
      
      <div *ngIf="selectedChat">
        <!-- Chat Header -->
        <div class="bg-white border-b border-gray-200 p-3 md:p-4 flex items-center justify-between shadow-sm">
          <div class="flex items-center space-x-2 md:space-x-3">
            <!-- Back Button (Mobile Only) -->
            <button *ngIf="isMobile" 
                    (click)="backToChatList()"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-100 mr-2">
              <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
            </button>
            
            <div class="relative flex-shrink-0">
              <img [src]="selectedChat.avatar" 
                   class="w-8 h-8 md:w-12 md:h-12 rounded-full border-2 border-gray-200" 
                   alt="avatar">
              <div *ngIf="selectedChat.isOnline" 
                   class="absolute bottom-0 right-0 w-2 h-2 md:w-3 md:h-3 bg-green-500 rounded-full border-2 border-white"></div>
            </div>
            <div class="min-w-0 flex-1">
              <h2 class="font-bold text-sm md:text-lg text-gray-800 truncate">{{ selectedChat.name }}</h2>
              <p class="text-xs md:text-sm text-gray-500 truncate">
                {{ selectedChat.isOnline ? 'Online' : 'Last seen ' + selectedChat.lastMessageTime }}
              </p>
            </div>
          </div>
          
          <!-- Chat Actions -->
          <div class="flex items-center space-x-1 md:space-x-2 flex-shrink-0">
            <button class="w-8 h-8 md:w-10 md:h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z"/>
              </svg>
            </button>
            <button class="w-8 h-8 md:w-10 md:h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Chat Messages -->
        <div #chatContainer class="flex-1 p-3 md:p-4 overflow-y-auto space-y-3 md:space-y-4" style="background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGNpcmNsZSBjeD0iMjAiIGN5PSIyMCIgcj0iMSIgZmlsbD0iIzAwMDAwMCIgZmlsbC1vcGFjaXR5PSIwLjAzIi8+Cjwvc3ZnPgo=');">
          <div *ngFor="let msg of selectedChat.chat" class="flex" 
               [ngClass]="msg.sender === 'me' ? 'justify-end' : 'justify-start'">
            
            <!-- Other Person's Message -->
            <div *ngIf="msg.sender !== 'me'" class="flex items-end space-x-2 max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg">
              <img [src]="selectedChat.avatar" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex-shrink-0" alt="avatar">
              <div class="bg-white rounded-2xl rounded-bl-md px-3 py-2 md:px-4 md:py-3 shadow-sm border">
                <p class="text-gray-800 text-sm md:text-base break-words">{{ msg.text }}</p>
                <p class="text-xs text-gray-500 mt-1">{{ msg.timestamp }}</p>
              </div>
            </div>
            
            <!-- My Message -->
            <div *ngIf="msg.sender === 'me'" class="flex items-end space-x-2 max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg">
              <div class="bg-[#6BA3BE] text-white rounded-2xl rounded-br-md px-3 py-2 md:px-4 md:py-3 shadow-sm">
                <p class="text-sm md:text-base break-words">{{ msg.text }}</p>
                <div class="flex items-center justify-end space-x-1 mt-1">
                  <span class="text-xs opacity-75">{{ msg.timestamp }}</span>
                  <span class="text-xs {{ getMessageStatusColor(msg.status) }}">
                    {{ getMessageStatusIcon(msg.status) }}
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Typing Indicator -->
          <div *ngIf="isTyping" class="flex justify-start">
            <div class="flex items-center space-x-2">
              <img [src]="selectedChat.avatar" class="w-6 h-6 md:w-8 md:h-8 rounded-full" alt="avatar">
              <div class="bg-white rounded-2xl px-3 py-2 md:px-4 md:py-3 shadow-sm">
                <div class="flex space-x-1">
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Enhanced Input Box -->
        <div class="bg-white border-t border-gray-200 p-3 md:p-4">
          <div class="flex items-center space-x-2 md:space-x-3">
            <!-- Attachment Button -->
            <button class="w-8 h-8 md:w-10 md:h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors flex-shrink-0">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
              </svg>
            </button>
            
            <!-- Message Input -->
            <div class="flex-1 relative">
              <input [(ngModel)]="newMessage"
                     (focus)="onInputFocus()"
                     (blur)="onInputBlur()"
                     (keyup.enter)="sendMessage()"
                     type="text"
                     placeholder="Type a message..."
                     class="w-full bg-gray-100 rounded-full px-3 py-2 md:px-4 md:py-3 pr-10 md:pr-12 text-sm md:text-base text-gray-800 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-[#6BA3BE] focus:bg-white transition-all">
              
              <!-- Emoji Button -->
              <button class="absolute right-2 md:right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 md:w-6 md:h-6 text-gray-500 hover:text-gray-700 text-sm md:text-base">
                ðŸ˜Š
              </button>
            </div>
            
            <!-- Send Button -->
            <button (click)="sendMessage()" 
                    [disabled]="!newMessage.trim()"
                    class="w-10 h-10 md:w-12 md:h-12 bg-[#6BA3BE] rounded-full flex items-center justify-center hover:bg-[#5a8fa4] disabled:bg-gray-300 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex-shrink-0">
              <svg class="w-4 h-4 md:w-6 md:h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- No Chat Selected State (Desktop Only) -->
    <div *ngIf="!selectedChat && !isMobile" class="w-full md:w-2/3 flex items-center justify-center bg-gray-50">
      <div class="text-center p-4">
        <div class="w-16 h-16 md:w-24 md:h-24 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
          <svg class="w-8 h-8 md:w-12 md:h-12 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
          </svg>
        </div>
        <h3 class="text-lg md:text-xl font-semibold text-gray-700 mb-2">Welcome to Messages</h3>
        <p class="text-sm md:text-base text-gray-500">Select a conversation to start messaging</p>
      </div>
    </div>
  </div>
</div>
