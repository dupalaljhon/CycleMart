<div class="flex h-screen bg-white">
  <!-- Sidenav - Hidden on mobile when chat is open -->
  <div [ngClass]="isMobile && showChatWindow ? 'hidden' : 'block'">
    <app-sidenav></app-sidenav>
  </div>

  <!-- Main Page Content -->
  <div class="flex-1 flex shadow-lg rounded-lg overflow-hidden bg-white m-2 md:m-4 h-full border border-black">
    
    <!-- Enhanced Sidebar Messages List -->
    <div [ngClass]="[
      'bg-white border-r border-black flex flex-col transition-all duration-300',
      isMobile ? (showChatList ? 'w-full' : 'hidden') : 'w-full md:w-1/3'
    ]">
      <!-- Sidebar Header -->
      <div class="bg-black text-white p-3 md:p-4 flex items-center justify-between">
        <div class="flex items-center space-x-2 md:space-x-3">
          <div class="w-8 h-8 md:w-10 md:h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
            <svg class="w-4 h-4 md:w-6 md:h-6" fill="currentColor" viewBox="0 0 24 24">
              <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
            </svg>
          </div>
          <div>
            <h2 class="font-bold text-base md:text-lg">Messages</h2>
            <p class="text-xs md:text-sm opacity-75">{{ getTotalUnreadCount() }} unread</p>
          </div>
        </div>
        
        <!-- Archive Messages Button -->
        <button 
          (click)="toggleArchivedMessages()"
          class="w-6 h-6 md:w-8 md:h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-white hover:text-black transition-all"
          [class.bg-white]="showArchivedMessages"
          [class.text-black]="showArchivedMessages">
          <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.83 1H5.42l.82-1zM5 19V8h14v11H5z"/>
          </svg>
        </button>
        
        <!-- Search Icon -->
        <button class="w-6 h-6 md:w-8 md:h-8 bg-white bg-opacity-20 rounded-full flex items-center justify-center hover:bg-white hover:text-black transition-all">
          <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
        </button>
      </div>

      <!-- Messages List -->
      <div class="flex-1 overflow-y-auto">
        <!-- Active Messages -->
        <div *ngIf="!showArchivedMessages">
          <div *ngFor="let chat of messages; let i = index" 
               [ngClass]="selectedChat?.conversation_id === chat.conversation_id ? 'bg-black bg-opacity-10 border-r-4 border-black' : 'hover:bg-gray-50'"
               class="flex items-center p-3 md:p-4 cursor-pointer border-b border-gray-300 transition-all duration-200 group"
               (click)="selectChat(i)">
            
            <div class="relative mr-2 md:mr-3 flex-shrink-0">
              <img [src]="chat.other_user_avatar" 
                   class="w-10 h-10 md:w-12 md:h-12 rounded-full border-2 border-black" 
                   alt="avatar">
            </div>
            
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between mb-1">
                <h3 class="font-semibold text-sm md:text-base text-black truncate">{{ chat.other_user_name }}</h3>
                <span class="text-xs text-gray-500 flex-shrink-0 ml-2">{{ chat.last_message_time }}</span>
              </div>
              <!-- Product Info -->
              <div class="text-xs text-gray-700 mb-1 truncate">
                {{ chat.product_name }} - ${{ chat.price }}
              </div>
              <div class="flex items-center justify-between">
                <p class="text-xs md:text-sm text-gray-700 truncate flex-1">{{ chat.last_message }}</p>
                <!-- Unread Badge -->
                <div *ngIf="chat.unread_count > 0" 
                     class="ml-2 bg-black text-white text-xs rounded-full w-4 h-4 md:w-5 md:h-5 flex items-center justify-center flex-shrink-0">
                  {{ chat.unread_count }}
                </div>
              </div>
            </div>
            
            <!-- Archive and Delete Buttons - Hidden on mobile, shown on hover on desktop -->
            <div class="flex items-center space-x-1">
              <button (click)="archiveChat(i); $event.stopPropagation()"
                      class="opacity-0 md:group-hover:opacity-100 w-5 h-5 md:w-6 md:h-6 text-black hover:text-gray-700 transition-all flex-shrink-0">
                <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.83 1H5.42l.82-1zM5 19V8h14v11H5z"/>
                </svg>
              </button>
              <button (click)="deleteChat(i); $event.stopPropagation()"
                      class="opacity-0 md:group-hover:opacity-100 w-5 h-5 md:w-6 md:h-6 text-red-500 hover:text-red-700 transition-all flex-shrink-0">
                <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
        
        <!-- Archived Messages -->
        <div *ngIf="showArchivedMessages">
          <div *ngIf="archivedMessages.length === 0" class="text-center py-8">
            <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-8 h-8 text-gray-400" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.83 1H5.42l.82-1zM5 19V8h14v11H5z"/>
              </svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-700 mb-2">No Archived Messages</h3>
            <p class="text-sm text-gray-500">You haven't archived any conversations yet</p>
          </div>
          
          <div *ngFor="let chat of archivedMessages; let i = index" 
               class="flex items-center p-3 md:p-4 cursor-pointer border-b border-gray-300 transition-all duration-200 group bg-gray-100 hover:bg-gray-200">
            
            <div class="relative mr-2 md:mr-3 flex-shrink-0">
              <img [src]="chat.other_user_avatar" 
                   class="w-10 h-10 md:w-12 md:h-12 rounded-full border-2 border-black opacity-75" 
                   alt="avatar">
              <!-- Archive indicator -->
              <div class="absolute -bottom-1 -right-1 bg-black rounded-full w-4 h-4 flex items-center justify-center">
                <svg class="w-2 h-2 text-white" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M20.54 5.23l-1.39-1.68C18.88 3.21 18.47 3 18 3H6c-.47 0-.88.21-1.16.55L3.46 5.23C3.17 5.57 3 6.02 3 6.5V19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6.5c0-.48-.17-.93-.46-1.27zM6.24 5h11.52l.83 1H5.42l.82-1zM5 19V8h14v11H5z"/>
                </svg>
              </div>
            </div>
            
            <div class="flex-1 min-w-0">
              <div class="flex items-center justify-between mb-1">
                <h3 class="font-semibold text-sm md:text-base text-gray-700 truncate">{{ chat.other_user_name }}</h3>
                <span class="text-xs text-gray-500 flex-shrink-0 ml-2">Archived</span>
              </div>
              <!-- Product Info -->
              <div class="text-xs text-gray-600 mb-1 truncate">
                {{ chat.product_name }} - ${{ chat.price }}
              </div>
              <div class="flex items-center justify-between">
                <p class="text-xs md:text-sm text-gray-600 truncate flex-1">{{ chat.last_message }}</p>
              </div>
            </div>
            
            <!-- Action Buttons for Archived Messages -->
            <div class="flex items-center space-x-1">
              <!-- Restore Button -->
              <button (click)="restoreChat(i); $event.stopPropagation()"
                      class="opacity-0 md:group-hover:opacity-100 w-5 h-5 md:w-6 md:h-6 text-green-600 hover:text-green-700 transition-all flex-shrink-0"
                      title="Restore conversation">
                <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9zm-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8H12z"/>
                </svg>
              </button>
              
              <!-- Delete Button -->
              <button (click)="deleteArchivedChat(i); $event.stopPropagation()"
                      class="opacity-0 md:group-hover:opacity-100 w-5 h-5 md:w-6 md:h-6 text-red-600 hover:text-red-700 transition-all flex-shrink-0"
                      title="Delete conversation permanently">
                <svg class="w-3 h-3 md:w-4 md:h-4" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Enhanced Chat Window -->
    <div [ngClass]="[
      'flex flex-col bg-white transition-all duration-300 h-full border-l border-black',
      isMobile ? (showChatWindow ? 'w-full' : 'hidden') : 'w-full md:w-2/3'
    ]" *ngIf="selectedChat || !isMobile">
      
      <div *ngIf="selectedChat" class="flex flex-col h-full">
        <!-- Chat Header -->
        <div class="bg-white border-b border-black p-3 md:p-4 flex items-center justify-between shadow-sm flex-shrink-0">
          <div class="flex items-center space-x-2 md:space-x-3 flex-1 min-w-0">
            <!-- Back Button (Mobile Only) -->
            <button *ngIf="isMobile" 
                    (click)="backToChatList()"
                    class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 mr-2 flex-shrink-0">
              <svg class="w-5 h-5 text-black" fill="currentColor" viewBox="0 0 24 24">
                <path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/>
              </svg>
            </button>
            
            <!-- User Avatar -->
            <div class="relative flex-shrink-0">
              <img [src]="selectedChat.other_user_avatar" 
                   class="w-10 h-10 md:w-12 md:h-12 rounded-full border-2 border-black object-cover" 
                   alt="avatar">
            </div>
            
            <!-- User Info and Product Info -->
            <div class="min-w-0 flex-1">
              <h2 class="font-bold text-sm md:text-lg text-black truncate">{{ selectedChat.other_user_name }}</h2>
              
              <!-- Enhanced Product Info with Image -->
              <div class="flex items-center space-x-2 mt-1">
                <!-- Product Image Thumbnail -->
                <div class="w-8 h-8 md:w-10 md:h-10 rounded-lg overflow-hidden border border-black flex-shrink-0 bg-gray-100">
                  <img [src]="getProductImageUrl(selectedChat.product_images)" 
                       class="w-full h-full object-cover" 
                       alt="Product"
                       (error)="$any($event.target).src = 'https://cdn-icons-png.flaticon.com/512/2972/2972185.png'">
                </div>
                
                <!-- Product Details -->
                <div class="min-w-0 flex-1">
                  <p class="text-xs md:text-sm text-gray-700 truncate font-medium">
                    {{ selectedChat.product_name }}
                  </p>
                  <p class="text-xs text-black font-semibold">
                    ${{ selectedChat.price | number:'1.2-2' }}
                  </p>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Chat Actions -->
          <div class="flex items-center space-x-1 md:space-x-2 flex-shrink-0">
            <!-- Mark as Sold/Traded Dropdown (Only for product owner) -->
            <div class="relative" *ngIf="isProductOwner()">
              <button 
                (click)="toggleStatusDropdown()"
                class="w-8 h-8 md:w-10 md:h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors">
                <svg class="w-4 h-4 md:w-5 md:h-5 text-black" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
              </button>
              
              <!-- Dropdown Menu -->
              <div *ngIf="showStatusDropdown" 
                   class="absolute right-0 top-full mt-2 w-48 bg-white rounded-lg shadow-lg border border-black z-50">
                <div class="py-2">
                  <button 
                    (click)="markProductStatus('sold')"
                    class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-200 hover:text-black flex items-center space-x-2">
                    <svg class="w-4 h-4 text-black" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                    </svg>
                    <span>Mark as Sold</span>
                  </button>
                  <button 
                    (click)="markProductStatus('traded')"
                    class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-200 hover:text-black flex items-center space-x-2">
                    <svg class="w-4 h-4 text-black" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M6.99 11L3 15l3.99 4v-3H14v-2H6.99v-3zM21 9l-3.99-4v3H10v2h7.01v3L21 9z"/>
                    </svg>
                    <span>Mark as Traded</span>
                  </button>
                  <button 
                    (click)="markProductStatus('reserved')"
                    class="w-full text-left px-4 py-2 text-sm text-black hover:bg-gray-200 hover:text-black flex items-center space-x-2">
                    <svg class="w-4 h-4 text-black" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"/>
                    </svg>
                    <span>Reserve Item</span>
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Report Button -->
            <button class="w-8 h-8 md:w-10 md:h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-black" fill="currentColor" viewBox="0 0 24 24">
                <path d="M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27L15.73 3zM12 17.3c-.72 0-1.3-.58-1.3-1.3 0-.72.58-1.3 1.3-1.3.72 0 1.3.58 1.3 1.3 0 .72-.58 1.3-1.3 1.3zm1-4.3h-2V7h2v6z"/>
              </svg>
            </button>

            <!-- Rate User Button (Only visible when product is sold/traded) -->
            <button 
              *ngIf="showRatingButton"
              (click)="openRatingModal()"
              class="w-8 h-8 md:w-10 md:h-10 bg-white border-2 border-black rounded-full flex items-center justify-center hover:bg-black hover:text-white transition-all duration-200 hover:scale-110 shadow-lg"
              title="Rate your experience with this seller">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-black hover:text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
              </svg>
            </button>

            <!-- Debug Socket Button -->
            <button 
              (click)="debugScrollState()"
              class="w-8 h-8 md:w-10 md:h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors"
              title="Debug scroll state">
              <svg class="w-4 h-4 md:w-5 md:h-5 text-black" fill="currentColor" viewBox="0 0 24 24">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
              </svg>
            </button>
          
          </div>
        </div>

        <!-- Chat Messages -->
        <div #chatContainer 
             (scroll)="onChatScroll($event)"
             class="flex-1 p-3 md:p-4 overflow-y-auto space-y-3 md:space-y-4 bg-gray-50 relative">
          <div *ngFor="let msg of selectedChat.messages; let i = index" class="flex" 
               [ngClass]="isMyMessage(msg.sender_id) ? 'justify-end' : 'justify-start'">
            
            <!-- Other Person's Message -->
            <div *ngIf="!isMyMessage(msg.sender_id)" class="flex items-end space-x-2 max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg animate-fadeIn">
              <img [src]="msg.sender_avatar" class="w-6 h-6 md:w-8 md:h-8 rounded-full flex-shrink-0 border-2 border-black shadow-sm" alt="avatar">
              <div class="bg-white rounded-2xl rounded-bl-md px-3 py-2 md:px-4 md:py-3 shadow-md border border-black hover:shadow-lg transition-shadow duration-200">
                
                <!-- Attachments -->
                <div *ngIf="msg.attachments && msg.attachments.length > 0" class="mb-2">
                  <div *ngFor="let attachment of msg.attachments" class="mb-2">
                    <!-- Image Attachment -->
                    <div *ngIf="attachment.type === 'image'" class="rounded-lg overflow-hidden">
                      <img [src]="attachment.url" 
                           [alt]="attachment.name || 'Image'"
                           class="max-w-full h-auto max-h-64 object-cover cursor-pointer hover:opacity-90 transition-opacity"
                           (click)="openAttachmentModal(attachment)">
                    </div>
                    
                    <!-- Video Attachment -->
                    <div *ngIf="attachment.type === 'video'" class="rounded-lg overflow-hidden">
                      <video controls class="max-w-full h-auto max-h-64">
                        <source [src]="attachment.url" type="video/mp4">
                        <source [src]="attachment.url" type="video/webm">
                        <source [src]="attachment.url" type="video/ogg">
                        Your browser does not support the video tag.
                      </video>
                      <div class="text-xs text-gray-500 mt-1">{{attachment.name}}</div>
                    </div>
                  </div>
                </div>

                <!-- Text Message -->
                <div *ngIf="msg.message_text" [innerHTML]="formatMessageText(msg.message_text)" class="text-black text-sm md:text-base break-words whitespace-pre-line"></div>
                
                <p class="text-xs text-gray-600 mt-1 flex items-center gap-1">
                  <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                  </svg>
                  {{ formatChatTime(msg.created_at) }}
                </p>
              </div>
            </div>
            
            <!-- My Message -->
            <div *ngIf="isMyMessage(msg.sender_id)" class="flex items-end space-x-2 max-w-xs sm:max-w-sm md:max-w-md lg:max-w-lg animate-fadeIn">
              <div class="bg-black text-white border-2 border-black rounded-2xl rounded-br-md px-3 py-2 md:px-4 md:py-3 shadow-md hover:shadow-lg transition-all duration-200 transform hover:scale-[1.02]">
                
                <!-- Attachments -->
                <div *ngIf="msg.attachments && msg.attachments.length > 0" class="mb-2">
                  <div *ngFor="let attachment of msg.attachments" class="mb-2">
                    <!-- Image Attachment -->
                    <div *ngIf="attachment.type === 'image'" class="rounded-lg overflow-hidden">
                      <img [src]="attachment.url" 
                           [alt]="attachment.name || 'Image'"
                           class="max-w-full h-auto max-h-64 object-cover cursor-pointer hover:opacity-90 transition-opacity"
                           (click)="openAttachmentModal(attachment)">
                    </div>
                    
                    <!-- Video Attachment -->
                    <div *ngIf="attachment.type === 'video'" class="rounded-lg overflow-hidden">
                      <video controls class="max-w-full h-auto max-h-64">
                        <source [src]="attachment.url" type="video/mp4">
                        <source [src]="attachment.url" type="video/webm">
                        <source [src]="attachment.url" type="video/ogg">
                        Your browser does not support the video tag.
                      </video>
                      <div class="text-xs text-white opacity-75 mt-1">{{attachment.name}}</div>
                    </div>
                  </div>
                </div>

                <!-- Text Message -->
                <div *ngIf="msg.message_text" [innerHTML]="formatMessageText(msg.message_text)" class="text-sm md:text-base break-words whitespace-pre-line"></div>
                
                <div class="flex items-center justify-end space-x-1 mt-1">
                  <span class="text-xs opacity-75">{{ formatChatTime(msg.created_at) }}</span>
                  <span class="text-xs opacity-75 flex items-center">
                    <svg class="w-3 h-3 ml-1" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                    </svg>
                    {{ msg.is_read ? 'âœ“' : '' }}
                  </span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Typing Indicator -->
          <!-- <div *ngIf="isTyping" class="flex justify-start">
            <div class="flex items-center space-x-2">
              <img [src]="selectedChat.other_user_avatar" class="w-6 h-6 md:w-8 md:h-8 rounded-full" alt="avatar">
              <div class="bg-white rounded-2xl px-3 py-2 md:px-4 md:py-3 shadow-sm">
                <div class="flex space-x-1">
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                  <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                </div>
              </div>
            </div>
          </div> -->
          
          <!-- Scroll to Bottom Button -->
          <div *ngIf="showScrollToBottomButton" 
               class="absolute bottom-6 right-6 z-20">
            <button 
              (click)="scrollToBottomManually()"
              class="w-12 h-12 bg-black text-white rounded-full shadow-xl hover:bg-gray-800 transition-all duration-200 flex items-center justify-center hover:scale-110 border-2 border-white"
              title="Scroll to bottom">
              <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                <path d="M16.59 8.59L12 13.17 7.41 8.59 6 10l6 6 6-6z"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Message Input (Fixed Bottom) -->
        <div class="bg-white border-t border-black pt-3 pb-2 px-3 md:pt-4 md:pb-2 md:px-4 flex-shrink-0">
          
          <!-- Attachment Previews -->
          <div *ngIf="attachmentPreviews.length > 0" class="mb-3">
            <div class="flex flex-wrap gap-2">
              <div *ngFor="let preview of attachmentPreviews; let i = index" 
                   class="relative bg-gray-100 rounded-lg overflow-hidden">
                <!-- Image Preview -->
                <div *ngIf="preview.type === 'image'" class="w-16 h-16 relative">
                  <img [src]="preview.preview" [alt]="preview.file.name" 
                       class="w-full h-full object-cover">
                  <button (click)="removeAttachment(i)"
                          class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 text-xs">
                    Ã—
                  </button>
                </div>
                
                <!-- Video Preview -->
                <div *ngIf="preview.type === 'video'" class="w-16 h-16 relative bg-gray-200 flex items-center justify-center">
                  <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M8 5v14l11-7z"/>
                  </svg>
                  <button (click)="removeAttachment(i)"
                          class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full flex items-center justify-center hover:bg-red-600 text-xs">
                    Ã—
                  </button>
                  <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-75 text-white text-xs p-1 truncate">
                    {{preview.file.name}}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="flex items-center space-x-2 md:space-x-3">
            <!-- Attachment Button -->
            <div class="relative">
              <input #fileInput 
                     type="file" 
                     multiple 
                     accept="image/*,video/*"
                     (change)="onAttachmentSelect($event)"
                     class="hidden">
              <button (click)="fileInput.click()"
                      class="w-8 h-8 md:w-10 md:h-10 bg-gray-100 rounded-full flex items-center justify-center hover:bg-gray-200 transition-colors flex-shrink-0">
                <svg class="w-4 h-4 md:w-5 md:h-5 text-black" fill="currentColor" viewBox="0 0 24 24">
                  <path d="M16.5 6v11.5c0 2.21-1.79 4-4 4s-4-1.79-4-4V5c0-1.38 1.12-2.5 2.5-2.5s2.5 1.12 2.5 2.5v10.5c0 .55-.45 1-1 1s-1-.45-1-1V6H10v9.5c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5V5c0-2.21-1.79-4-4-4S7 2.79 7 5v12.5c0 3.04 2.46 5.5 5.5 5.5s5.5-2.46 5.5-5.5V6h-1.5z"/>
                </svg>
              </button>
            </div>

            <!-- Input Field -->
            <div class="flex-1 relative"
                 (dragover)="onDragOver($event)"
                 (dragleave)="onDragLeave($event)"
                 (drop)="onDrop($event)">
              <input [(ngModel)]="newMessage"
                     (focus)="onInputFocus()"
                     (blur)="onInputBlur()"
                     (keydown)="onMessageKeyDown($event)"
                     (input)="onMessageInput()"
                     type="text"
                     placeholder="Type a message or drag files here..."
                     [ngClass]="isDragOver ? 'bg-blue-100 border-blue-300' : 'bg-gray-100'"
                     class="w-full rounded-full px-3 py-2 md:px-4 md:py-3 pr-10 md:pr-12 text-sm md:text-base text-black placeholder-gray-600 focus:outline-none focus:ring-2 focus:ring-black focus:bg-white transition-all border-2 border-transparent">
              
              <!-- Emoji Button -->
              <button class="absolute right-2 md:right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 md:w-6 md:h-6 text-black hover:text-gray-700 text-sm md:text-base">
                ðŸ˜Š
              </button>
            </div>

            <!-- Send Button -->
            <button (click)="sendMessage()" 
                    [disabled]="!newMessage.trim() && attachmentPreviews.length === 0"
                    class="w-10 h-10 md:w-12 md:h-12 bg-black rounded-full flex items-center justify-center hover:bg-gray-800 disabled:bg-gray-400 disabled:cursor-not-allowed transition-all shadow-lg hover:shadow-xl transform hover:scale-105 flex-shrink-0">
              <svg class="w-4 h-4 md:w-6 md:h-6 text-white" fill="currentColor" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
            </button>
          </div>
        </div>
      </div>

    </div>

    <!-- No Chat Selected State (Desktop Only) -->
    <div *ngIf="!selectedChat && !isMobile" class="w-full md:w-2/3 flex items-center justify-center bg-white">
      <div class="text-center p-4">
        <div class="w-16 h-16 md:w-24 md:h-24 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4 border border-black">
          <svg class="w-8 h-8 md:w-12 md:h-12 text-black" fill="currentColor" viewBox="0 0 24 24">
            <path d="M20 2H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h4l4 4 4-4h4c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>
          </svg>
        </div>
        <h3 class="text-lg md:text-xl font-semibold text-black mb-2">Welcome to Messages</h3>
        <p class="text-sm md:text-base text-gray-600">Select a conversation to start messaging</p>
      </div>
    </div>
  </div>

  <!-- Rating Modal -->
  <app-rating-modal 
    *ngIf="showRatingModal && selectedChat && getRatedUserInfo()"
    [conversationId]="selectedChat.conversation_id"
    [ratedUser]="getRatedUserInfo()!"
    [productId]="selectedChat.product_id"
    [productName]="selectedChat.product_name"
    (modalClosed)="closeRatingModal()"
    (ratingSubmitted)="onRatingSubmitted($event)">
  </app-rating-modal>

  <!-- Attachment Modal -->
  <div *ngIf="showAttachmentModal && selectedAttachment" 
       class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4"
       (click)="closeAttachmentModal()">
    <div class="relative max-w-4xl max-h-full w-full h-full flex items-center justify-center"
         (click)="$event.stopPropagation()">
      
      <!-- Close Button -->
      <button 
        (click)="closeAttachmentModal()"
        class="absolute top-4 right-4 z-10 text-white rounded-full w-12 h-12 flex items-center justify-center hover:bg-white hover:bg-opacity-20 transition-opacity">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
        </svg>
      </button>

      <!-- Attachment Display -->
      <div class="max-w-full max-h-full">
        <!-- Image -->
        <img *ngIf="selectedAttachment.type === 'image'" 
             [src]="selectedAttachment.url" 
             [alt]="selectedAttachment.name || 'Image'"
             class="max-w-full max-h-full object-contain">
        
        <!-- Video -->
        <video *ngIf="selectedAttachment.type === 'video'" 
               controls autoplay class="max-w-full max-h-full">
          <source [src]="selectedAttachment.url" type="video/mp4">
          <source [src]="selectedAttachment.url" type="video/webm">
          <source [src]="selectedAttachment.url" type="video/ogg">
          Your browser does not support the video tag.
        </video>
      </div>

      <!-- Attachment Info -->
      <div *ngIf="selectedAttachment.name" 
           class="absolute bottom-4 left-4 text-white bg-black bg-opacity-50 px-3 py-2 rounded-lg">
        {{selectedAttachment.name}}
      </div>
    </div>
  </div>

</div>
