<!-- Standalone Reports Page Layout (with sidenav) -->
<div *ngIf="!isModal" class="flex h-screen bg-white">
  <!-- Sidenav -->
  <app-sidenav></app-sidenav>

  <!-- Main Content -->
  <div class="flex-1 p-4 md:p-6 bg-white overflow-y-auto">
    <!-- Header -->
    <div class="mb-6">
      <h1 class="text-2xl font-bold text-black mb-2">My Reports</h1>
      <p class="text-gray-600">View and track your submitted reports</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="flex justify-center items-center h-64">
      <mat-spinner diameter="50"></mat-spinner>
    </div>

    <!-- Empty State -->
    <div *ngIf="!loading && reports.length === 0" class="text-center py-16">
      <div class="bg-white border border-gray-300 rounded-lg p-8">
        <div class="text-6xl mb-4 text-gray-400">üìã</div>
        <h3 class="text-xl font-bold text-black mb-4">No Reports Yet</h3>
        <p class="text-gray-600 mb-6">You haven't submitted any reports yet.</p>
        <button mat-raised-button 
                color="primary" 
                class="bg-black text-white hover:bg-gray-800"
                (click)="goBack()">
          Back to Home
        </button>
      </div>
    </div>

    <!-- Reports Table -->
    <div *ngIf="!loading && reports.length > 0" class="bg-white border border-gray-300 rounded-lg overflow-hidden">
      <div class="overflow-x-auto">
        <table mat-table [dataSource]="reports" class="w-full">
          
          <!-- Product Image Column -->
          <ng-container matColumnDef="product_image">
            <th mat-header-cell *matHeaderCellDef class="bg-gray-100 text-black font-bold">Product</th>
            <td mat-cell *matCellDef="let report" class="text-black">
              <div class="flex items-center">
                <img [src]="getProductImageUrl(report.product_images)" 
                     [alt]="report.product_name || 'Product image'"
                     class="w-12 h-12 object-cover rounded border border-gray-300"
                     (error)="onImageError($event)">
                <div class="ml-3" *ngIf="report.product_name">
                  <div class="text-sm font-medium text-black">{{report.product_name}}</div>
                  <div class="text-xs text-gray-600">#{{report.report_id}}</div>
                </div>
                <div class="ml-3" *ngIf="!report.product_name">
                  <div class="text-sm text-gray-600">Product #{{report.product_id}}</div>
                  <div class="text-xs text-gray-600">Report #{{report.report_id}}</div>
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Reason Type Column -->
          <ng-container matColumnDef="reason_type">
            <th mat-header-cell *matHeaderCellDef class="bg-gray-100 text-black font-bold">Reason</th>
            <td mat-cell *matCellDef="let report" class="text-black">
              <mat-chip class="bg-gray-200 text-black">
                {{getReasonTypeLabel(report.reason_type)}}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Target Column -->
          <ng-container matColumnDef="target">
            <th mat-header-cell *matHeaderCellDef class="bg-gray-100 text-black font-bold">Target</th>
            <td mat-cell *matCellDef="let report" class="text-black">
              <div *ngIf="report.product_id">
                <strong>Product:</strong> {{report.product_name || 'Product #' + report.product_id}}
                <div class="text-sm text-gray-600" *ngIf="report.product_price">
                  Price: ${{report.product_price}}
                </div>
              </div>
              <div *ngIf="report.reported_user_id">
                <strong>User:</strong> {{report.reported_user_name || 'User #' + report.reported_user_id}}
                <div class="text-sm text-gray-600" *ngIf="report.reported_user_email">
                  {{report.reported_user_email}}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Proof Column -->
          <ng-container matColumnDef="proof">
            <th mat-header-cell *matHeaderCellDef class="bg-gray-100 text-black font-bold">Proof</th>
            <td mat-cell *matCellDef="let report" class="text-black">
              <div *ngIf="!report.proof || report.proof === '' || report.proof === 'null' || report.proof === '[]' || getProofFileUrls(report.proof).length === 0" 
                   class="text-sm text-gray-600 italic">
                No proof
              </div>
              <div *ngIf="report.proof && report.proof !== '' && report.proof !== 'null' && report.proof !== '[]' && getProofFileUrls(report.proof).length > 0" 
                   class="flex flex-col items-center gap-1">
                <button mat-button 
                        (click)="viewProofFiles(report)"
                        class="text-blue-600 hover:bg-blue-50 rounded px-3 py-1 text-sm">
                  <mat-icon class="text-base mr-1">visibility</mat-icon>
                  <span class="text-sm">View ({{ getProofFileUrls(report.proof).length }})</span>
                </button>
              </div>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef class="bg-gray-100 text-black font-bold">Status</th>
            <td mat-cell *matCellDef="let report" class="text-black">
              <mat-chip [class]="getStatusClass(report.status)">
                {{getStatusText(report.status)}}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Created Date Column -->
          <ng-container matColumnDef="created_at">
            <th mat-header-cell *matHeaderCellDef class="bg-gray-100 text-black font-bold">Date</th>
            <td mat-cell *matCellDef="let report" class="text-black">
              {{formatDate(report.created_at)}}
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="bg-gray-100 text-black font-bold">Actions</th>
            <td mat-cell *matCellDef="let report" class="text-black">
              <button mat-button 
                      class="text-black hover:bg-gray-100"
                      (click)="viewReportDetails(report)">
                View Details
              </button>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumns;" class="hover:bg-gray-50"></tr>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal Version (no sidenav) -->
<div *ngIf="isModal" class="report-modal-container">
  <!-- Header -->
  <div class="report-modal-header">
    <h2 class="text-xl font-bold text-black mb-2">
      Report {{ prefilledProduct ? 'Product' : prefilledUser ? 'User' : 'Content' }}
    </h2>
    <p class="text-gray-600">Help us maintain a safe community by reporting inappropriate content or behavior.</p>
  </div>

  <!-- Submit Report Form -->
  <form (ngSubmit)="submitReport()" #reportFormRef="ngForm" class="report-form-container">
    
    <!-- Debug Section (Development Only) -->
    <!-- <div class="mb-4 p-3 bg-gray-100 rounded border">
      <h3 class="text-sm font-bold mb-2">Debug Info:</h3>
      <p class="text-xs">Modal: {{ isModal }}, User: {{ currentUser?.id || 'None' }}</p>
      <p class="text-xs">Report Types: {{ reportTypes.length }}, Selected: {{ reportForm.reason_type || 'None' }}</p>
      <p class="text-xs">Product: {{ prefilledProduct?.product_name || 'None' }}</p>
    </div> -->
    
    <!-- Target Type Selection (hidden if prefilled) -->
    <div *ngIf="!prefilledProduct && !prefilledUser" class="form-field-container">
      <mat-form-field appearance="outline" class="w-full report-form-field">
        <mat-label>What are you reporting?</mat-label>
        <mat-select [(ngModel)]="reportForm.target_type" name="target_type">
          <mat-option value="user">User/Profile</mat-option>
          <mat-option value="product">Product/Listing</mat-option>
        </mat-select>
      </mat-form-field>
    </div>

    <!-- Target Identifier (hidden if prefilled) -->
    <div *ngIf="!prefilledProduct && !prefilledUser" class="form-field-container">
      <mat-form-field appearance="outline" class="w-full report-form-field">
        <mat-label>{{ reportForm.target_type === 'user' ? 'User ID' : 'Product ID' }}</mat-label>
        <input matInput 
               type="number" 
               [(ngModel)]="reportForm.target_identifier" 
               name="target_identifier"
               [placeholder]="'Enter ' + reportForm.target_type + ' ID'"
               required>
      </mat-form-field>
    </div>

    <!-- Reason Type -->
    <div class="form-field-container">
      <!-- Test with basic HTML select first -->
      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-2">Test Basic Select:</label>
        <select [(ngModel)]="reportForm.reason_type" 
                name="test_reason_type"
                class="w-full p-2 border border-gray-300 rounded">
          <option value="">Select a reason...</option>
          <option value="scam">‚ö†Ô∏è Scam/Fraud</option>
          <option value="fake product">üö´ Fake Product</option>
          <option value="spam">üìß Spam</option>
          <option value="inappropriate content">üîû Inappropriate Content</option>
          <option value="misleading information">‚ùå Misleading Information</option>
          <option value="stolen item">üö® Stolen Item</option>
          <option value="others">üìù Others</option>
        </select>
      </div>
      
      <!-- Material Select -->

      <!-- Debug info to see if reportTypes is loaded -->
      <div class="text-xs text-gray-500 mt-1">
        Debug: reportTypes.length = {{ reportTypes.length }}, Selected: {{ reportForm.reason_type || 'None' }}
      </div>
    </div>

    <!-- Reason Details -->
    <div class="form-field-container">
      <mat-form-field appearance="fill" class="w-full report-form-field">
        <mat-label>Detailed Explanation</mat-label>
        <textarea matInput 
                  [(ngModel)]="reportForm.reason_details" 
                  name="reason_details"
                  placeholder="Please provide detailed information about why you are reporting this..."
                  required
                  minlength="10"
                  rows="4"
                  class="report-textarea"></textarea>
      </mat-form-field>
    </div>

    <!-- Proof Upload Section -->
    <div class="form-field-container">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Upload Proof (Optional)
        <span class="text-xs text-gray-500 ml-1">- Images or videos that support your report</span>
      </label>
      
      <!-- File Upload Area -->
      <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center bg-gray-50 hover:bg-gray-100 transition-colors"
           (dragover)="onDragOver($event)"
           (dragleave)="onDragLeave($event)"
           (drop)="onProofFilesDrop($event)">
        
        <!-- Upload Icon and Text -->
        <div class="mb-4">
          <mat-icon class="text-4xl text-gray-400 mb-2">cloud_upload</mat-icon>
          <p class="text-gray-600">
            Drag and drop files here or 
            <label class="text-blue-600 hover:text-blue-800 cursor-pointer underline">
              browse files
              <input type="file" 
                     #proofFileInput
                     multiple 
                     accept="image/*,video/*"
                     (change)="onProofFilesSelected($event)"
                     class="hidden">
            </label>
          </p>
          <p class="text-xs text-gray-500 mt-1">
            Supported: Images (JPEG, PNG, GIF) and Videos (MP4, WebM, MOV) ‚Ä¢ Max {{maxFileSize / (1024 * 1024)}}MB per file ‚Ä¢ Up to {{maxProofFiles}} files
          </p>
        </div>
      </div>

      <!-- Selected Files Preview -->
      <div *ngIf="proofPreviews.length > 0" class="mt-4">
        <h4 class="text-sm font-medium text-gray-700 mb-2">Selected Proof Files ({{proofPreviews.length}}/{{maxProofFiles}}):</h4>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          <div *ngFor="let preview of proofPreviews; let i = index" 
               class="relative bg-white border border-gray-200 rounded-lg p-2">
            
            <!-- Image Preview -->
            <div *ngIf="preview.type === 'image'" class="aspect-square bg-gray-100 rounded overflow-hidden mb-2">
              <img [src]="preview.url" 
                   [alt]="preview.file.name"
                   class="w-full h-full object-cover">
            </div>
            
            <!-- Video Preview -->
            <div *ngIf="preview.type === 'video'" class="aspect-square bg-gray-100 rounded overflow-hidden mb-2 flex items-center justify-center">
              <video [src]="preview.url" 
                     class="w-full h-full object-cover"
                     controls="false"
                     muted>
              </video>
              <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 rounded">
                <mat-icon class="text-white text-2xl">play_circle</mat-icon>
              </div>
            </div>
            
            <!-- File Info -->
            <div class="text-xs text-gray-600 truncate mb-1" [title]="preview.file.name">
              {{ preview.file.name }}
            </div>
            <div class="text-xs text-gray-500">
              {{ (preview.file.size / 1024 / 1024).toFixed(1) }} MB
            </div>
            
            <!-- Remove Button -->
            <button type="button"
                    (click)="removeProofFile(i)"
                    class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center hover:bg-red-600 transition-colors">
              <mat-icon class="text-sm">close</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Submit Buttons -->
    <div class="report-form-actions">
      <button mat-button 
              type="button" 
              class="report-cancel-btn"
              (click)="goBack()">
        Cancel
      </button>
      <button mat-raised-button 
              type="submit" 
              class="report-submit-btn"
              [disabled]="loading">
        <span *ngIf="loading">Submitting...</span>
        <span *ngIf="!loading">Submit Report</span>
      </button>
    </div>
  </form>
</div>

<!-- Simple Modal for Messages -->
<div *ngIf="showModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" (click)="closeModal()">
  <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 border border-gray-300" (click)="$event.stopPropagation()">
    <div class="text-center">
      <h3 class="text-lg font-bold text-black mb-4">{{ modalTitle }}</h3>
      <p class="text-gray-600 mb-6">{{ modalMessage }}</p>
      <button mat-raised-button 
              class="bg-black text-white hover:bg-gray-800"
              (click)="closeModal()">
        OK
      </button>
    </div>
  </div>
</div>

<!-- Proof Files Viewing Modal -->
<div *ngIf="showProofModal" 
     class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm"
     style="z-index: 9999;"
     (click)="closeProofModal()">
  <div class="relative w-full max-w-5xl max-h-[95vh] bg-white rounded-xl shadow-xl overflow-hidden mx-4" 
       (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="flex justify-between items-center px-6 py-4 bg-white border-b border-gray-100">
      <div class="flex items-center space-x-3">
        <div class="w-10 h-10 bg-blue-50 rounded-lg flex items-center justify-center">
          <mat-icon class="text-blue-600 text-lg">attach_file</mat-icon>
        </div>
        <div>
          <h3 class="text-lg font-medium text-gray-900">
            Proof Files
          </h3>
          <p class="text-sm text-gray-500">
            <!-- Report #{{ currentReportId }} ‚Ä¢ {{ currentProofIndex + 1 }} of {{ currentProofFiles.length }} -->
              {{ currentProofIndex + 1 }} of {{ currentProofFiles.length }}
          </p>
        </div>
      </div>
      <button mat-icon-button 
              (click)="closeProofModal()" 
              class="text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Modal Content -->
    <div class="flex flex-col items-center justify-center p-8 min-h-[500px] max-h-[75vh] overflow-auto bg-gray-50">
      <!-- Image Display -->
      <div *ngIf="isCurrentFileImage()" class="flex flex-col items-center w-full">
        <div class="relative bg-white rounded-lg shadow-sm p-4 max-w-full">
          <img [src]="getCurrentProofFile()" 
               [alt]="'Proof file ' + (currentProofIndex + 1)"
               class="max-w-full max-h-[60vh] object-contain rounded-md"
               (error)="onModalImageError($event)">
        </div>
        <p class="mt-4 text-sm text-gray-600 text-center font-medium">
          {{ getProofFileType(getCurrentProofFile()) }} ‚Ä¢ File {{ currentProofIndex + 1 }} of {{ currentProofFiles.length }}
        </p>
      </div>

      <!-- Video Display -->
      <div *ngIf="isCurrentFileVideo()" class="flex flex-col items-center w-full">
        <div class="relative bg-white rounded-lg shadow-sm p-4 max-w-full">
          <video [src]="getCurrentProofFile()" 
                 controls 
                 class="max-w-full max-h-[60vh] rounded-md"
                 preload="metadata">
            Your browser does not support the video tag.
          </video>
        </div>
        <p class="mt-4 text-sm text-gray-600 text-center font-medium">
          {{ getProofFileType(getCurrentProofFile()) }} ‚Ä¢ File {{ currentProofIndex + 1 }} of {{ currentProofFiles.length }}
        </p>
      </div>

      <!-- Unsupported File Type -->
      <div *ngIf="!isCurrentFileImage() && !isCurrentFileVideo()" class="flex flex-col items-center text-center">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mb-4">
          <mat-icon class="text-4xl text-gray-400">insert_drive_file</mat-icon>
        </div>
        <h4 class="text-lg font-medium text-gray-800 mb-2">Preview Not Available</h4>
        <p class="text-sm text-gray-500 mb-6 max-w-md">This file type cannot be previewed in the browser.</p>
        <button mat-raised-button 
                color="primary" 
                (click)="openProofFile(getCurrentProofFile())"
                class="bg-blue-600 text-white hover:bg-blue-700">
          <mat-icon class="mr-2">open_in_new</mat-icon>
          Open File
        </button>
      </div>

      <!-- Error State -->
      <div *ngIf="currentProofFiles.length === 0" class="flex flex-col items-center text-center">
        <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center mb-4">
          <mat-icon class="text-4xl text-red-400">error_outline</mat-icon>
        </div>
        <h4 class="text-lg font-medium text-gray-800 mb-2">No Files Available</h4>
        <p class="text-sm text-gray-500">No proof files found for this report.</p>
      </div>
    </div>

    <!-- Modal Footer with Navigation -->
    <div *ngIf="currentProofFiles.length > 0" class="flex justify-between items-center px-6 py-4 bg-white border-t border-gray-100">
      <!-- Previous Button -->
      <button mat-button 
              [disabled]="currentProofIndex === 0"
              (click)="previousProofFile()"
              class="text-gray-600 hover:bg-gray-100 rounded px-4 py-2">
        <mat-icon class="mr-1 text-lg">chevron_left</mat-icon>
        Previous
      </button>

      <!-- File Navigation Indicators -->
      <div class="flex items-center space-x-4">
        <span class="text-sm text-gray-500 font-medium">
          {{ currentProofIndex + 1 }} / {{ currentProofFiles.length }}
        </span>
        <!-- Dots Navigation -->
        <div class="flex space-x-1" *ngIf="currentProofFiles.length > 1">
          <button *ngFor="let file of currentProofFiles; let i = index" 
                  class="w-2 h-2 rounded-full transition-all duration-200 focus:outline-none"
                  [class.bg-blue-600]="i === currentProofIndex"
                  [class.bg-gray-300]="i !== currentProofIndex"
                  [class.hover:bg-gray-400]="i !== currentProofIndex"
                  (click)="currentProofIndex = i">
          </button>
        </div>
      </div>

      <!-- Next Button -->
      <button mat-button 
              [disabled]="currentProofIndex === currentProofFiles.length - 1"
              (click)="nextProofFile()"
              class="text-gray-600 hover:bg-gray-100 rounded px-4 py-2">
        Next
        <mat-icon class="ml-1 text-lg">chevron_right</mat-icon>
      </button>
    </div>
  </div>
</div>