<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Edit Flow Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; line-height: 1.6; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        .results { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 3px; white-space: pre-wrap; }
        input, textarea, select { width: 100%; padding: 8px; margin: 5px 0; }
        .spec-row { display: flex; gap: 10px; margin: 5px 0; }
        .spec-row input { flex: 1; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Complete Edit Flow Test - SPECIFICATIONS FOCUSED</h1>
        
        <div class="test-section">
            <h3>1. Authentication Check</h3>
            <button onclick="checkAuth()">Check Authentication</button>
            <div id="authResults" class="results"></div>
        </div>

        <div class="test-section">
            <h3>2. Product Loading & Specifications Test</h3>
            <input type="number" id="productId" placeholder="Enter Product ID" value="59">
            <button onclick="loadProductWithSpecs()">Load Product + Specifications</button>
            <div id="loadResults" class="results"></div>
        </div>

        <div class="test-section">
            <h3>3. Edit Form Simulation</h3>
            <div id="editForm" style="display: none;">
                <h4>Product Details</h4>
                <input type="text" id="productName" placeholder="Product Name">
                <input type="number" id="productPrice" placeholder="Price">
                <textarea id="productDescription" placeholder="Description"></textarea>
                <input type="text" id="productLocation" placeholder="Location">
                
                <h4>Specifications</h4>
                <div id="specifications">
                    <!-- Specifications will be loaded here -->
                </div>
                <button onclick="addSpecification()">Add Specification</button>
                
                <br><br>
                <button onclick="testSaveChanges()">Test Save Changes</button>
            </div>
            <div id="editResults" class="results"></div>
        </div>

        <div class="test-section">
            <h3>4. Direct API Test</h3>
            <button onclick="testDirectAPI()">Test Update API Directly</button>
            <div id="apiResults" class="results"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost/CycleMart/CycleMart-api/api/';
        let currentProduct = null;
        let userId = null;

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : '';
            return `<span class="${className}">[${timestamp}] ${message}</span>\n`;
        }

        async function checkAuth() {
            const resultsDiv = document.getElementById('authResults');
            let results = '';
            
            results += log('üîç Checking Authentication...', 'info');
            
            userId = localStorage.getItem('user_id');
            const userEmail = localStorage.getItem('user_email');
            
            if (userId && userEmail) {
                results += log(`‚úÖ User found: ID ${userId}, Email: ${userEmail}`, 'success');
                
                try {
                    const response = await fetch(`${API_BASE}getUser?id=${userId}`);
                    const userData = await response.json();
                    
                    if (userData.status === 'success') {
                        results += log(`‚úÖ User verified: ${userData.data.email}`, 'success');
                    } else {
                        results += log(`‚ùå User verification failed: ${userData.message}`, 'error');
                    }
                } catch (error) {
                    results += log(`‚ùå API Error: ${error.message}`, 'error');
                }
            } else {
                results += log('‚ùå No user authentication. Please log in first.', 'error');
            }
            
            resultsDiv.innerHTML = results;
        }

        async function loadProductWithSpecs() {
            const resultsDiv = document.getElementById('loadResults');
            const productId = document.getElementById('productId').value;
            let results = '';
            
            if (!productId) {
                results += log('‚ùå Please enter a Product ID', 'error');
                resultsDiv.innerHTML = results;
                return;
            }
            
            results += log(`üîç Loading product ${productId} with specifications...`, 'info');
            
            try {
                // Step 1: Load product data
                const productResponse = await fetch(`${API_BASE}getProduct?id=${productId}`);
                const productData = await productResponse.json();
                
                if (productData.status !== 'success') {
                    results += log(`‚ùå Failed to load product: ${productData.message}`, 'error');
                    resultsDiv.innerHTML = results;
                    return;
                }
                
                currentProduct = productData.data[0];
                results += log(`‚úÖ Product loaded: ${currentProduct.product_name}`, 'success');
                results += log(`   Owner: ${currentProduct.uploader_id}, Current User: ${userId}`, 'info');
                
                // Check authorization
                if (userId != currentProduct.uploader_id) {
                    results += log(`‚ö†Ô∏è WARNING: You don't own this product (Owner: ${currentProduct.uploader_id}, You: ${userId})`, 'warning');
                } else {
                    results += log(`‚úÖ Authorization OK - You own this product`, 'success');
                }
                
                // Step 2: Load specifications
                results += log(`üîç Loading specifications for product ${productId}...`, 'info');
                const specsResponse = await fetch(`${API_BASE}product-specifications?product_id=${productId}`);
                const specsData = await specsResponse.json();
                
                if (specsData.status === 'success') {
                    results += log(`‚úÖ Specifications loaded: ${specsData.data.length} items`, 'success');
                    
                    specsData.data.forEach((spec, index) => {
                        results += log(`   ${index + 1}. ${spec.spec_name}: ${spec.spec_value}`, 'info');
                    });
                    
                    // Populate the form
                    populateEditForm(currentProduct, specsData.data);
                    
                } else {
                    results += log(`‚ö†Ô∏è No specifications found: ${specsData.message}`, 'warning');
                    populateEditForm(currentProduct, []);
                }
                
                document.getElementById('editForm').style.display = 'block';
                
            } catch (error) {
                results += log(`‚ùå Error: ${error.message}`, 'error');
            }
            
            resultsDiv.innerHTML = results;
        }

        function populateEditForm(product, specifications) {
            document.getElementById('productName').value = product.product_name;
            document.getElementById('productPrice').value = product.price;
            document.getElementById('productDescription').value = product.description;
            document.getElementById('productLocation').value = product.location;
            
            // Populate specifications
            const specsDiv = document.getElementById('specifications');
            specsDiv.innerHTML = '';
            
            specifications.forEach(spec => {
                addSpecificationRow(spec.spec_name, spec.spec_value);
            });
            
            // Add empty row for new specs
            if (specifications.length === 0) {
                addSpecificationRow('', '');
            }
        }

        function addSpecification() {
            addSpecificationRow('', '');
        }

        function addSpecificationRow(name = '', value = '') {
            const specsDiv = document.getElementById('specifications');
            const div = document.createElement('div');
            div.className = 'spec-row';
            div.innerHTML = `
                <input type="text" class="spec-name" placeholder="Specification Name" value="${name}">
                <input type="text" class="spec-value" placeholder="Specification Value" value="${value}">
                <button onclick="this.parentElement.remove()">Remove</button>
            `;
            specsDiv.appendChild(div);
        }

        async function testSaveChanges() {
            const resultsDiv = document.getElementById('editResults');
            let results = '';
            
            if (!currentProduct) {
                results += log('‚ùå No product loaded. Load a product first.', 'error');
                resultsDiv.innerHTML = results;
                return;
            }
            
            results += log('üîÑ Testing Save Changes...', 'info');
            
            // Collect form data
            const specifications = [];
            const specNames = document.querySelectorAll('.spec-name');
            const specValues = document.querySelectorAll('.spec-value');
            
            for (let i = 0; i < specNames.length; i++) {
                if (specNames[i].value.trim() && specValues[i].value.trim()) {
                    specifications.push({
                        spec_name: specNames[i].value.trim(),
                        spec_value: specValues[i].value.trim()
                    });
                }
            }
            
            const updateData = {
                product_id: parseInt(currentProduct.product_id),
                product_name: document.getElementById('productName').value,
                brand_name: currentProduct.brand_name || 'no brand',
                custom_brand: currentProduct.custom_brand || '',
                price: parseFloat(document.getElementById('productPrice').value),
                description: document.getElementById('productDescription').value,
                location: document.getElementById('productLocation').value,
                for_type: currentProduct.for_type,
                condition: currentProduct.condition,
                category: currentProduct.category,
                quantity: parseInt(currentProduct.quantity),
                product_images: currentProduct.product_images || '[]',
                product_videos: currentProduct.product_videos || '[]',
                specifications: specifications,
                uploader_id: parseInt(currentProduct.uploader_id)
            };
            
            results += log(`üìã Update Data Prepared:`, 'info');
            results += log(`   Product ID: ${updateData.product_id}`, 'info');
            results += log(`   Product Name: ${updateData.product_name}`, 'info');
            results += log(`   Uploader ID: ${updateData.uploader_id}`, 'info');
            results += log(`   Specifications Count: ${specifications.length}`, 'info');
            
            specifications.forEach((spec, index) => {
                results += log(`      ${index + 1}. ${spec.spec_name}: ${spec.spec_value}`, 'info');
            });
            
            try {
                const response = await fetch(`${API_BASE}updateProduct`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(updateData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    results += log(`‚úÖ SAVE SUCCESSFUL: ${result.message}`, 'success');
                    
                    // Verify specifications were saved
                    results += log(`üîç Verifying specifications were saved...`, 'info');
                    const verifyResponse = await fetch(`${API_BASE}product-specifications?product_id=${currentProduct.product_id}`);
                    const verifyData = await verifyResponse.json();
                    
                    if (verifyData.status === 'success') {
                        results += log(`‚úÖ Verification successful: ${verifyData.data.length} specifications saved`, 'success');
                        verifyData.data.forEach((spec, index) => {
                            results += log(`   ${index + 1}. ${spec.spec_name}: ${spec.spec_value}`, 'info');
                        });
                    } else {
                        results += log(`‚ö†Ô∏è Verification failed: ${verifyData.message}`, 'warning');
                    }
                    
                } else {
                    results += log(`‚ùå SAVE FAILED: ${result.message}`, 'error');
                }
                
            } catch (error) {
                results += log(`‚ùå Network Error: ${error.message}`, 'error');
            }
            
            resultsDiv.innerHTML = results;
        }

        async function testDirectAPI() {
            const resultsDiv = document.getElementById('apiResults');
            let results = '';
            
            results += log('üß™ Testing Direct API...', 'info');
            
            // Test with a known working product
            const testData = {
                product_id: 59,
                product_name: 'BMX - API Test',
                brand_name: 'Test Brand',
                custom_brand: '',
                price: 299.99,
                description: 'Direct API test description',
                location: 'Test Location',
                for_type: 'sale',
                condition: 'good',
                category: 'bicycle',
                quantity: 1,
                product_images: '[]',
                product_videos: '[]',
                specifications: [
                    { spec_name: 'API Test Spec', spec_value: 'API Test Value' },
                    { spec_name: 'Direct Test', spec_value: 'Working' }
                ],
                uploader_id: 1
            };
            
            results += log(`üìã Direct API Test Data:`, 'info');
            results += log(`${JSON.stringify(testData, null, 2)}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}updateProduct`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    results += log(`‚úÖ DIRECT API TEST PASSED: ${result.message}`, 'success');
                } else {
                    results += log(`‚ùå DIRECT API TEST FAILED: ${result.message}`, 'error');
                }
                
            } catch (error) {
                results += log(`‚ùå Direct API Error: ${error.message}`, 'error');
            }
            
            resultsDiv.innerHTML = results;
        }

        // Auto-check authentication on page load
        window.onload = function() {
            checkAuth();
        };
    </script>
</body>
</html>