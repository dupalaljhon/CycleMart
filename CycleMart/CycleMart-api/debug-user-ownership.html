<!DOCTYPE html>
<html>
<head>
    <title>User Authentication Debug</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; }
        .success { color: green; }
        .error { color: red; }
        .warning { color: orange; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>üîç User Authentication & Product Ownership Debug</h1>
    
    <div class="section">
        <h3>Current User Info</h3>
        <div id="userInfo"></div>
        <button onclick="checkCurrentUser()">Check Current User</button>
    </div>
    
    <div class="section">
        <h3>Product Ownership Check</h3>
        <input type="number" id="productId" placeholder="Product ID" value="59">
        <button onclick="checkProductOwnership()">Check Product Ownership</button>
        <div id="ownershipInfo"></div>
    </div>
    
    <div class="section">
        <h3>Find Your Products</h3>
        <button onclick="findUserProducts()">Find My Products</button>
        <div id="userProducts"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost/CycleMart/CycleMart-api/api/';
        
        function log(message, type = 'info') {
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : type === 'warning' ? 'warning' : 'info';
            return `<div class="${className}">${message}</div>`;
        }
        
        async function checkCurrentUser() {
            const div = document.getElementById('userInfo');
            let html = '';
            
            // Check localStorage
            const userId = localStorage.getItem('user_id');
            const userEmail = localStorage.getItem('user_email');
            
            html += log('üìã LocalStorage Info:', 'info');
            html += log(`User ID: ${userId || 'NOT SET'}`, userId ? 'success' : 'error');
            html += log(`User Email: ${userEmail || 'NOT SET'}`, userEmail ? 'success' : 'error');
            
            if (userId) {
                try {
                    const response = await fetch(`${API_BASE}getUser?id=${userId}`);
                    const userData = await response.json();
                    
                    html += log('üìã API Verification:', 'info');
                    if (userData.status === 'success') {
                        html += log(`‚úÖ User exists: ${userData.data.full_name} (${userData.data.email})`, 'success');
                        html += log(`Database ID: ${userData.data.id} (matches: ${userData.data.id == userId ? 'YES' : 'NO'})`, userData.data.id == userId ? 'success' : 'error');
                    } else {
                        html += log(`‚ùå User verification failed: ${userData.message}`, 'error');
                    }
                } catch (error) {
                    html += log(`‚ùå API Error: ${error.message}`, 'error');
                }
            }
            
            div.innerHTML = html;
        }
        
        async function checkProductOwnership() {
            const div = document.getElementById('ownershipInfo');
            const productId = document.getElementById('productId').value;
            const userId = localStorage.getItem('user_id');
            let html = '';
            
            if (!productId) {
                html += log('‚ùå Please enter a Product ID', 'error');
                div.innerHTML = html;
                return;
            }
            
            html += log(`üîç Checking ownership of Product ID: ${productId}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}getProduct?id=${productId}`);
                const productData = await response.json();
                
                if (productData.status === 'success' && productData.data.length > 0) {
                    const product = productData.data[0];
                    
                    html += log(`üìã Product Info:`, 'info');
                    html += log(`Name: ${product.product_name}`, 'info');
                    html += log(`Owner ID: ${product.uploader_id}`, 'info');
                    html += log(`Current User ID: ${userId}`, 'info');
                    
                    if (product.uploader_id == userId) {
                        html += log(`‚úÖ YOU OWN THIS PRODUCT - Can edit`, 'success');
                    } else {
                        html += log(`‚ùå YOU DON'T OWN THIS PRODUCT - Cannot edit`, 'error');
                        html += log(`This is why you get "Product not found or unauthorized" error`, 'warning');
                    }
                } else {
                    html += log(`‚ùå Product not found: ${productData.message}`, 'error');
                }
            } catch (error) {
                html += log(`‚ùå API Error: ${error.message}`, 'error');
            }
            
            div.innerHTML = html;
        }
        
        async function findUserProducts() {
            const div = document.getElementById('userProducts');
            const userId = localStorage.getItem('user_id');
            let html = '';
            
            if (!userId) {
                html += log('‚ùå No user logged in', 'error');
                div.innerHTML = html;
                return;
            }
            
            html += log(`üîç Finding products owned by User ID: ${userId}`, 'info');
            
            try {
                const response = await fetch(`${API_BASE}getUserProducts?user_id=${userId}`);
                const productsData = await response.json();
                
                if (productsData.status === 'success' && productsData.data.length > 0) {
                    html += log(`‚úÖ Found ${productsData.data.length} products you own:`, 'success');
                    
                    productsData.data.forEach((product, index) => {
                        html += log(`${index + 1}. ID: ${product.product_id} - ${product.product_name} ($${product.price})`, 'info');
                    });
                    
                    html += log(`üí° TIP: Use one of these Product IDs to test editing`, 'warning');
                } else {
                    html += log(`‚ö†Ô∏è No products found for your account`, 'warning');
                    html += log(`This means you don't have any products to edit`, 'warning');
                }
            } catch (error) {
                html += log(`‚ùå API Error: ${error.message}`, 'error');
            }
            
            div.innerHTML = html;
        }
        
        // Auto-check on page load
        window.onload = function() {
            checkCurrentUser();
        };
    </script>
</body>
</html>