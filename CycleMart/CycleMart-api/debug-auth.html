<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug User Authentication</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background: #0056b3; }
        .info { background: #f8f9fa; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .error { color: red; }
        .success { color: green; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üîç Debug User Authentication</h1>
    
    <div class="section">
        <h3>LocalStorage Debug</h3>
        <button onclick="checkLocalStorage()">Check LocalStorage</button>
        <button onclick="clearLocalStorage()">Clear LocalStorage</button>
        <div id="localStorageResult"></div>
    </div>

    <div class="section">
        <h3>Manual Login Test</h3>
        <input type="email" id="email" placeholder="Email" value="cyclemrt@gmail.com">
        <input type="password" id="password" placeholder="Password" value="">
        <button onclick="testLogin()">Test Login</button>
        <div id="loginResult"></div>
    </div>

    <div class="section">
        <h3>User Data Test</h3>
        <input type="number" id="userId" placeholder="User ID" value="30">
        <button onclick="testGetUser()">Test Get User</button>
        <div id="userResult"></div>
    </div>

    <div class="section">
        <h3>Product Data Test</h3>
        <input type="number" id="productId" placeholder="Product ID" value="29">
        <button onclick="testGetProduct()">Test Get Product</button>
        <div id="productResult"></div>
    </div>

    <div class="section">
        <h3>Authorization Test</h3>
        <p>This will test if the current user can edit the specified product:</p>
        <button onclick="testAuthorization()">Test Authorization</button>
        <div id="authResult"></div>
    </div>

    <script>
        const API_BASE = 'http://localhost/CycleMart/CycleMart/CycleMart-api/api/';

        function checkLocalStorage() {
            const resultDiv = document.getElementById('localStorageResult');
            const userData = {
                id: localStorage.getItem('id'),
                email: localStorage.getItem('email'),
                full_name: localStorage.getItem('full_name'),
                allKeys: Object.keys(localStorage)
            };
            
            resultDiv.innerHTML = `
                <div class="info">
                    <h4>LocalStorage Contents:</h4>
                    <pre>${JSON.stringify(userData, null, 2)}</pre>
                </div>
            `;
        }

        function clearLocalStorage() {
            localStorage.clear();
            document.getElementById('localStorageResult').innerHTML = '<div class="success">LocalStorage cleared!</div>';
        }

        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('loginResult');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<div class="error">Please enter both email and password</div>';
                return;
            }

            try {
                const response = await fetch(API_BASE + 'login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const result = await response.json();
                console.log('Login result:', result);

                if (result.status === 'success') {
                    // Store in localStorage like the real app would
                    if (result.data && result.data.user) {
                        localStorage.setItem('id', result.data.user.id);
                        localStorage.setItem('email', result.data.user.email);
                        localStorage.setItem('full_name', result.data.user.full_name);
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="success">‚úÖ Login successful!</div>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div class="error">‚ùå Login failed: ${result.message}</div>
                        <pre>${JSON.stringify(result, null, 2)}</pre>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Network error: ${error.message}</div>`;
            }
        }

        async function testGetUser() {
            const userId = document.getElementById('userId').value;
            const resultDiv = document.getElementById('userResult');
            
            try {
                const response = await fetch(API_BASE + 'user?id=' + userId);
                const result = await response.json();
                
                resultDiv.innerHTML = `
                    <h4>User Data:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testGetProduct() {
            const productId = document.getElementById('productId').value;
            const resultDiv = document.getElementById('productResult');
            
            try {
                const response = await fetch(API_BASE + 'products?product_id=' + productId);
                const result = await response.json();
                
                resultDiv.innerHTML = `
                    <h4>Product Data:</h4>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        async function testAuthorization() {
            const resultDiv = document.getElementById('authResult');
            const currentUserId = localStorage.getItem('id');
            const productId = document.getElementById('productId').value;
            
            if (!currentUserId) {
                resultDiv.innerHTML = '<div class="error">‚ùå No user logged in (no ID in localStorage)</div>';
                return;
            }

            try {
                // Get product data
                const response = await fetch(API_BASE + 'products?product_id=' + productId);
                const result = await response.json();
                
                if (result.status === 'success' && result.data && result.data[0]) {
                    const product = result.data[0];
                    const canEdit = parseInt(currentUserId) === parseInt(product.uploader_id);
                    
                    resultDiv.innerHTML = `
                        <div class="info">
                            <h4>Authorization Check:</h4>
                            <p><strong>Current User ID:</strong> ${currentUserId}</p>
                            <p><strong>Product Uploader ID:</strong> ${product.uploader_id}</p>
                            <p><strong>Can Edit:</strong> ${canEdit ? '‚úÖ YES' : '‚ùå NO'}</p>
                        </div>
                        ${!canEdit ? '<div class="error">‚ö†Ô∏è This will cause "Product not found or unauthorized" error!</div>' : '<div class="success">‚úÖ Authorization should work!</div>'}
                    `;
                } else {
                    resultDiv.innerHTML = '<div class="error">‚ùå Could not get product data</div>';
                }
            } catch (error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${error.message}</div>`;
            }
        }

        // Auto-check localStorage on page load
        window.onload = function() {
            checkLocalStorage();
        };
    </script>
</body>
</html>